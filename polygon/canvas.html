<!doctype html>
<html>
<head>
<meta charset="utf-8">
<style>
.img{position:absolute;z-index:1;}

#container{
    display:inline-block;
    position:relative; 
}
#test {
    position:relative;
    left:-200px;
    z-index:20;
}
</style>
<script type="text/javascript" src="jquery-1.11.1.js"></script>
<script type="text/javascript" src="geometry.js"></script>
<script type="text/javascript" src="quadtree.js"></script>
<script>
$(document).ready(function() {
    // temporary test data
    var pts = [
        {x:20,y:20},
        {x:100,y:35},
        {x:150,y:80},
        {x:90,y:88},
        {x:40,y:60},
        {x:20,y:20}
    ];
    downPt = undefined;
    qt = new QuadTree(0,0,200,100);
    polygon = new Polygon( pts, "test" );
    qt.addPolygon(polygon);
    upPt = undefined;
    $("#test").mousemove(function( event ) {
        var offset = $("#test").offset();
        var pt = new Point(event.pageX-offset.left,event.pageY-offset.top);
        if ( !polygon.anchored )
        {
            var ctx = $("#test")[0].getContext("2d");
            if ( polygon.pointInPoly(pt) )
                polygon.drawPolygon(ctx);
            else
            {
                polygon.erase(ctx);
                var newPoly = qt.pointInPolygon(pt);
                if ( newPoly )
                    polygon = newPoly;
            }
        }
        else if ( polygon.dragging() )
        {
            var quad = qt.getQuad(polygon.dragPt);
            polygon.dragTo(pt);
            quad.removePt(polygon.dragPt);
            qt.addPt(polygon.dragPt);
        }
        else if ( downPt != undefined && polygon.anchored && !polygon.pointInPoly(downPt) )
        {
            var ctx = $("#test")[0].getContext("2d");
            if ( upPt != undefined )
            {
                var r = clipRect();
                ctx.save();
                ctx.rect(r.x,r.y,r.width,r.height);
                ctx.clip();
                polygon.redraw(ctx);
                ctx.restore();
            }
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(downPt.x,downPt.y);
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.setLineDash([2,3]);
            ctx.lineTo(pt.x,pt.y);
            ctx.stroke();
            ctx.restore();
            upPt = pt;
        }
    });
    $("#test").mousedown(function(event) {
        var offset = $("#test").offset();
        var pt = new Point(event.pageX-offset.left,event.pageY-offset.top);
        if ( polygon.anchored )
        {
            var inside = polygon.pointInPoly(pt);
            var closest = qt.hasPoint(pt,undefined);
            var dist = (closest!=undefined)?qt.distance(closest,pt):Number.MAX_VALUE;
            if ( dist<=polygon.radius )
            {
                polygon.startDrag(closest);
            }
            else if ( polygon.ptOnEdge(pt) )
            {
                var newPt = polygon.addPt(pt);
                qt.addPt(newPt);
                qt.updatePolygon(polygon);
            }
            else 
            {
                if ( inside )
                {
                    polygon.setAnchorNormal();
                }
                upPt= undefined;
            }
            downPt = pt;
        }
        else
        {
            polygon.anchored = polygon.pointInPoly(pt);
            if ( polygon.anchored )
            {
                var ctx = $("#test")[0].getContext("2d");
                polygon.drawControlPoints(ctx);
            }
        }
    });
    $("#test").mouseup(function(event) {
        var offset = $("#test").offset();
        var pt = new Point(event.pageX-offset.left,event.pageY-offset.top);
        var closest = qt.hasPoint(pt,undefined);
        //this stops endDrag from being called
        if ( closest!=undefined && closest.equals(polygon.dragPt) )
            polygon.setHighlightPt(closest);
        else if ( polygon.dragging() )
        {
            var quad = qt.getQuad(polygon.dragPt);
            if ( quad != undefined )
            {
                quad.removePt(polygon.dragPt);
                polygon.dragTo(pt);
                qt.addPt(polygon.dragPt);
                polygon.endDrag(qt);
            }
            else
                console.log("quad for "+polygon.dragPt.x
                +":"+polygon.y+" is undefined");
        }
        else if ( downPt != undefined )
        {
             var upInPoly = polygon.pointInPoly(pt);
	         if ( !upInPoly )
             {
                 if ( downPt.equals(pt) )
                 {
                     var ctx = $("#test")[0].getContext("2d");
                     polygon.erase(ctx);
                     polygon.anchored = false;
                 }
             }
        }
        if ( downPt != undefined && upPt != undefined )
        {
            var polygons = polygon.split(downPt,upPt);
            qt.removePolygon( polygon );
            if ( polygons != undefined )
            {
                for ( var i=0;i<polygons.length;i++ )
                    qt.addPolygon(polygons[i]);
                if( polygons.length>0 )
                    polygon = polygons[0];
            }
            //var r = clipRect();
            //var ctx = $("#test")[0].getContext("2d");
            //polygon.redraw(ctx);
        }
        downPt = undefined;
        upPt = undefined;
    });
    $(document).keydown(function(event){
        if ( polygon.highlightPt != undefined )
            if ( event.which == 8 || event.which == 46 )
            {
                qt.removePt(polygon.highlightPt);
                qt.updatePolygon(polygon);
                polygon.deleteHighlightPt();
            }
        // otherwise we should remove the whole polygon
        return false;
    });
    function clipRect()
    {
        var left = (downPt.x<upPt.x)?downPt.x:upPt.x;
        var right = (downPt.x>upPt.x)?downPt.x:upPt.x;
        var top = (upPt.y<downPt.y)?upPt.y:downPt.y;
        var bot = (upPt.y>downPt.y)?upPt.y:downPt.y;
        var r = new Rect(left,top,right-left,bot-top);
        r.expand( 2 );
        return r;
    }
});
</script>
</head>
<body>
<div id="container">
<img src="test.png">
<canvas id="test" width="200" height="100"></canvas>
</div>
</body>
</html>
